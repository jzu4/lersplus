<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolr Payment Gateway</title>
    <!-- ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿÆÿ∑ ÿπÿ±ÿ®Ÿä ÿ≠ÿØŸäÿ´ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. CSS Variables & Reset
           ========================================= */
        :root {
            --primary-gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            --secondary-gradient: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --error-color: #ef4444;
            --success-color: #10b981;
            --radius: 16px;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: var(--secondary-gradient);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.5;
            z-index: -1;
        }

        /* =========================================
           2. Layout & Card
           ========================================= */
        .container {
            width: 100%;
            max-width: 500px;
            z-index: 1;
        }

        .card {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Top Accent */
        .card::top {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: var(--primary-gradient);
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-color);
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 0.5rem;
        }

        .logo span {
            color: var(--text-main);
        }

        .subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        /* =========================================
           3. Form Elements
           ========================================= */
        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 0.6rem;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .input-wrapper {
            position: relative;
        }

        /* Icons inside inputs */
        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
            pointer-events: none;
        }

        input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem; /* Space for icon */
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background-color: #f8fafc;
            transition: var(--transition);
            outline: none;
            font-weight: 600;
        }

        input:focus {
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        input.error {
            border-color: var(--error-color);
            background-color: #fef2f2;
        }

        .error-msg {
            font-size: 0.8rem;
            color: var(--error-color);
            margin-top: 0.4rem;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 5px;
        }

        /* =========================================
           4. Button
           ========================================= */
        .btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loader */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* =========================================
           5. Footer & Extras
           ========================================= */
        footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* Status Box */
        .status-box {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-box.processing {
            background-color: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Debug Area */
        .debug-console {
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #0f172a;
            color: #4ade80;
            padding: 15px;
            border-radius: 8px;
            max-height: 120px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
            display: none;
            border: 1px solid #334155;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo">
                Dolr<span>Pay</span>
            </div>
            <p class="subtitle">ÿØŸÅÿπ ÿ¢ŸÖŸÜ Ÿàÿ≥ÿ±Ÿäÿπ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿÆÿØŸÖÿßÿ™</p>
        </header>

        <main class="card">
            <form id="paymentForm" novalidate>
                <!-- Amount -->
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ®ŸÑÿ∫ (SAR)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üí∞</span>
                        <input type="number" id="amount" step="0.01" min="0.01" placeholder="0.00" required>
                    </div>
                    <div class="error-msg" id="error-amount">‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿµÿ≠Ÿäÿ≠</div>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label>ŸàÿµŸÅ ÿßŸÑÿ∑ŸÑÿ®</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üìù</span>
                        <input type="text" id="description" placeholder="ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®..." required>
                    </div>
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                    <div class="input-wrapper">
                        <span class="input-icon">‚úâÔ∏è</span>
                        <input type="email" id="email" placeholder="example@mail.com" required>
                    </div>
                </div>

                <!-- Phone -->
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ (12 ÿ±ŸÇŸÖ)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üì±</span>
                        <input type="tel" id="phone" placeholder="05xxxxxxxx" maxlength="12" required>
                    </div>
                    <div class="error-msg" id="error-phone">‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑÿ±ŸÇŸÖ 12 ÿ±ŸÇŸÖ</div>
                </div>

                <button type="submit" class="btn" id="payBtn">
                    <span class="btn-text">ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ ÿßŸÑÿ¢ŸÖŸÜ</span>
                    <div class="spinner"></div>
                </button>
            </form>

            <!-- Processing / Status Message -->
            <div id="statusBox" class="status-box processing">
                ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ∑ŸÑÿ® Ÿàÿ™ÿ≠ÿ∂Ÿäÿ± ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ...
            </div>
        </main>

        <footer>
            &copy; 2026 Dolr. ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©.
        </footer>

        <!-- Optional Debug for Developer -->
        <div id="debugConsole" class="debug-console"></div>
    </div>

    <script>
        // =======================================================
        // CONFIGURATION
        // =======================================================
        const CONFIG = {
            MERCHANT_ID: "6450ac35-9df8-4ad5-ab72-cec67bf773bf",
            MERCHANT_PASSWORD: "57f605d4-90c0-43e0-9b3a-091935d5bb8a", 
            EdfaPay_URL: "https://api.edfapay.com/payment/initiate",
            // Relative Paths as requested
            URLS: {
                term_url_3ds: "/buytvapp/callback.php",
                success_url: "/buytvapp/success.php",
                failure_url: "/buytvapp/error.php",
                callback_url: "/buytvapp/callback.php"
            },
            CURRENCY: "SAR"
        };

        // DOM Elements
        const form = document.getElementById('paymentForm');
        const amountInput = document.getElementById('amount');
        const phoneInput = document.getElementById('phone');
        const payBtn = document.getElementById('payBtn');
        const btnText = payBtn.querySelector('.btn-text');
        const spinner = payBtn.querySelector('.spinner');
        const statusBox = document.getElementById('statusBox');
        const debugConsole = document.getElementById('debugConsole');

        // Logger
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugConsole.innerHTML += `<div>[${time}] ${msg}</div>`;
            debugConsole.style.display = 'block';
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }

        // MD5 Function (Minified for single file)
        function md5(string){function rotateLeft(lValue,iShiftBits){return(lValue<<iShiftBits)|(lValue>>>(32-iShiftBits));}function addUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;lX8=(lX&0x80000000);lY8=(lY&0x80000000);lX4=(lX&0x40000000);lY4=(lY&0x40000000);lResult=(lX&0x3FFFFFFF)+(lY&0x3FFFFFFF);if(lX4&lY4)return(lResult^0x80000000^lX8^lY8);if(lX4|lY4){if(lResult&0x40000000)return(lResult^0xC0000000^lX8^lY8);else return(lResult^0x40000000^lX8^lY8);}else return(lResult^lX8^lY8);}function F(x,y,z){return(x&y)|((~x)&z);}function G(x,y,z){return(x&z)|(y&(~z));}function H(x,y,z){return(x^y^z);}function I(x,y,z){return(y^(x|(~z)));}function FF(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(F(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b);}function GG(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(G(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b);}function HH(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(H(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b);}function II(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(I(b,c,d),x),ac));return addUnsigned(rotateLeft(a,s),b);}function convertToWordArray(string){var lWordCount;var lMessageLength=string.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1%64))/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=(lWordArray[lWordCount]|(string.charCodeAt(lByteCount)<<lBytePosition));lByteCount++;}lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=lWordArray[lWordCount]|(0x80<<lBytePosition);lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray;}function wordToHex(lValue){var wordToHexValue="",wordToHexValue_temp="",lByte,lCount;for(lCount=0;lCount<=3;lCount++){lByte=(lValue>>>(lCount*8))&255;wordToHexValue_temp="0"+lByte.toString(16);wordToHexValue=wordToHexValue+wordToHexValue_temp.substr(wordToHexValue_temp.length-2,2);}return wordToHexValue;}var x=Array();var k,AA,BB,CC,DD,a,b,c,d;var S11=7,S12=12,S13=17,S14=22;var S21=5,S22=9,S23=14,S24=20;var S31=4,S32=11,S33=16,S34=23;var S41=6,S42=10,S43=15,S44=21;string=unescape(encodeURIComponent(string));x=convertToWordArray(string);a=0x67452301;b=0xEFCDAB89;c=0x98BADCFE;d=0x10325476;for(k=0;k<x.length;k+=16){AA=a;BB=b;CC=c;DD=d;a=FF(a,b,c,d,x[k+0],S11,0xD76AA478);d=FF(d,a,b,c,x[k+1],S12,0xE8C7B756);c=FF(c,d,a,b,x[k+2],S13,0x242070DB);b=FF(b,c,d,a,x[k+3],S14,0xC1BDCEEE);a=FF(a,b,c,d,x[k+4],S11,0xF57C0FAF);d=FF(d,a,b,c,x[k+5],S12,0x4787C62A);c=FF(c,d,a,b,x[k+6],S13,0xA8304613);b=FF(b,c,d,a,x[k+7],S14,0xFD469501);a=FF(a,b,c,d,x[k+8],S11,0x698098D8);d=FF(d,a,b,c,x[k+9],S12,0x8B44F7AF);c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1);b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);a=FF(a,b,c,d,x[k+12],S11,0x6B901122);d=FF(d,a,b,c,x[k+13],S12,0xFD987193);c=FF(c,d,a,b,x[k+14],S13,0xA679438E);b=FF(b,c,d,a,x[k+15],S14,0x49B40821);a=GG(a,b,c,d,x[k+1],S21,0xF61E2562);d=GG(d,a,b,c,x[k+6],S22,0xC040B340);c=GG(c,d,a,b,x[k+11],S23,0x265E5A51);b=GG(b,c,d,a,x[k+0],S24,0xE9B6C7AA);a=GG(a,b,c,d,x[k+5],S21,0xD62F105D);d=GG(d,a,b,c,x[k+10],S22,0x02441453);c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681);b=GG(b,c,d,a,x[k+4],S24,0xE7D3FBC8);a=GG(a,b,c,d,x[k+9],S21,0x21E1CDE6);d=GG(d,a,b,c,x[k+14],S22,0xC33707D6);c=GG(c,d,a,b,x[k+3],S23,0xF4D50D87);b=GG(b,c,d,a,x[k+6],S24,0x455A14ED);a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905);d=GG(d,a,b,c,x[k+2],S22,0xFCEFA3F8);c=GG(c,d,a,b,x[k+7],S23,0x676F02D9);b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);a=HH(a,b,c,d,x[k+5],S31,0xFFFA3942);d=HH(d,a,b,c,x[k+8],S32,0x8771F681);c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122);b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);a=HH(a,b,c,d,x[k+1],S31,0xA4BEEA44);d=HH(d,a,b,c,x[k+4],S32,0x4BDECFA9);c=HH(c,d,a,b,x[k+7],S33,0xF6BB4B60);b=HH(b,c,d,a,x[k+10],S34,0xBEBFBC70);a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6);d=HH(d,a,b,c,x[k+0],S32,0xEAA127FA);c=HH(c,d,a,b,x[k+3],S33,0xD4EF3085);b=HH(b,c,d,a,x[k+6],S34,0x04881D05);a=HH(a,b,c,d,x[k+9],S31,0xD9D4D039);d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5);c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8);b=HH(b,c,d,a,x[k+2],S34,0xC4AC5665);a=II(a,b,c,d,x[k+0],S41,0xF4292244);d=II(d,a,b,c,x[k+7],S42,0x432AFF97);c=II(c,d,a,b,x[k+14],S43,0xAB9423A7);b=II(b,c,d,a,x[k+5],S44,0xFC93A039);a=II(a,b,c,d,x[k+12],S41,0x655B59C3);d=II(d,a,b,c,x[k+3],S42,0x8F0CCC92);c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D);b=II(b,c,d,a,x[k+1],S44,0x85845DD1);a=II(a,b,c,d,x[k+8],S41,0x6FA87E4F);d=II(d,a,b,c,x[k+15],S42,0xFE2CE6E0);c=II(c,d,a,b,x[k+6],S43,0xA3014314);b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);a=II(a,b,c,d,x[k+4],S41,0xF7537E82);d=II(d,a,b,c,x[k+11],S42,0xBD3AF235);c=II(c,d,a,b,x[k+2],S43,0x2AD7D2BB);b=II(b,c,d,a,x[k+9],S44,0xEB86D391);a=addUnsigned(a,AA);b=addUnsigned(b,BB);c=addUnsigned(c,CC);d=addUnsigned(d,DD);}return(wordToHex(a)+wordToHex(b)+wordToHex(c)+wordToHex(d)).toLowerCase();}

        async function sha1(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-1', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Helper: Create and Download JSON (Simulating server file creation)
        function createOrderJSON(orderObj, orderId) {
            const dataStr = JSON.stringify(orderObj, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `dolr_order_${orderId}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            log(`JSON File Downloaded: ${exportFileDefaultName}`);
        }

        // =======================================================
        // MAIN HANDLER
        // =======================================================
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Reset UI
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
            document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
            statusBox.style.display = 'none';
            debugConsole.style.display = 'none'; // Hide previous logs

            // Validation
            let amount = parseFloat(amountInput.value);
            const description = document.getElementById('description').value.trim();
            const email = document.getElementById('email').value.trim();
            let phone = phoneInput.value.replace(/\D+/g, '');
            let isValid = true;

            if (isNaN(amount) || amount <= 0) {
                document.getElementById('error-amount').style.display = 'block';
                amountInput.classList.add('error');
                isValid = false;
            }
            if (!/^[0-9]{12}$/.test(phone)) {
                document.getElementById('error-phone').style.display = 'block';
                phoneInput.classList.add('error');
                isValid = false;
            }
            if (!isValid) return;

            // Lock UI
            payBtn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            statusBox.style.display = 'block';

            // --- 1. Generate Order ID (dolr-) ---
            const orderId = "dolr-" + Math.floor(Date.now() / 1000); 
            const formattedAmount = amount.toFixed(2);
            const currency = CONFIG.CURRENCY;

            log(`Order ID: ${orderId}`);

            // --- 2. Generate Hash ---
            const hashBase = (orderId + formattedAmount + currency + description + CONFIG.MERCHANT_PASSWORD).toUpperCase();
            log(`Hash Base: ${hashBase}`);
            
            const md5Hash = md5(hashBase);
            const finalHash = await sha1(md5Hash);
            log(`Final Hash: ${finalHash}`);

            // --- 3. Prepare Data ---
            const orderData = {
                order_id: orderId,
                amount: formattedAmount,
                currency: currency,
                description: description,
                email: email,
                phone: phone,
                created_at: Math.floor(Date.now() / 1000)
            };

            // Save to LocalStorage
            const orders = JSON.parse(localStorage.getItem('dolr_orders') || '{}');
            orders[orderId] = orderData;
            localStorage.setItem('dolr_orders', JSON.stringify(orders));

            // Simulate File Creation (Download JSON)
            createOrderJSON(orderData, orderId);

            // --- 4. Send Request ---
            const formData = new FormData();
            formData.append("action", "SALE");
            formData.append("edfa_merchant_id", CONFIG.MERCHANT_ID);
            formData.append("order_id", orderId);
            formData.append("order_amount", formattedAmount);
            formData.append("order_currency", currency);
            formData.append("order_description", description);
            formData.append("req_token", "Y");
            formData.append("payer_first_name", "Dolr");
            formData.append("payer_last_name", "Customer");
            formData.append("payer_email", email);
            formData.append("payer_phone", phone);
            formData.append("payer_country", "SA");
            formData.append("payer_city", "Riyadh");
            formData.append("payer_address", "Online");
            formData.append("payer_zip", "12221");
            formData.append("payer_ip", "127.0.0.1");
            formData.append("term_url_3ds", CONFIG.URLS.term_url_3ds);
            formData.append("success_url", CONFIG.URLS.success_url);
            formData.append("failure_url", CONFIG.URLS.failure_url);
            formData.append("callback_url", CONFIG.URLS.callback_url);
            formData.append("auth", "N");
            formData.append("recurring_init", "N");
            formData.append("hash", finalHash);

            try {
                log("Sending request...");
                const response = await fetch(CONFIG.EdfaPay_URL, {
                    method: 'POST',
                    body: formData,
                    headers: { "Accept": "application/json" }
                });

                const data = await response.json();
                log(`Response: ${JSON.stringify(data)}`);

                if (data && data.redirect_url) {
                    // --- 5. Direct Redirect ---
                    statusBox.innerHTML = `‚úÖ ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑÿ∑ŸÑÿ® <strong>${orderId}</strong><br>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸàŸäŸÑŸÉ ŸÑÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ...`;
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1500);
                } else {
                    throw new Error(data.error || "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØŸÅÿπ");
                }

            } catch (error) {
                log(`Error: ${error.message}`);
                statusBox.classList.remove('processing');
                statusBox.style.color = '#dc2626';
                statusBox.style.backgroundColor = '#fee2e2';
                statusBox.style.borderColor = '#fecaca';
                statusBox.textContent = `ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}`;
                
                payBtn.disabled = false;
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
